<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <title>MDM • AI Maker Teks To Image</title>
  <meta name="description" content="MDM (marilmu dot marepeng) • AI Maker Teks To Image - Ubah teks menjadi gambar AI, cepat dan elegan." />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
  --brand: #0A1F44; /* biru dongker MDM */
  --bg: #ffffff;
  --fg: #0b1220;
  --muted: #8A93A5;
  --card: #f6f8fb;
  --border: #e6e8ef;
  --bar: linear-gradient(90deg, #2b6cb0, #0ea5e9);
  --ring: rgba(10, 31, 68, 0.15);
}

html[data-theme="dark"] {
  --bg: #0A0F1A;
  --fg: #ECF0F8;
  --muted: #9AA3B2;
  --card: #0F1726;
  --border: #18223A;
  --bar: linear-gradient(90deg, #60a5fa, #38bdf8);
  --ring: rgba(236, 240, 248, 0.15);
}

* { box-sizing: border-box; }
html, body {
  height: 100%;
}
body { display:flex; flex-direction:column; background: var(--bg); color: var(--fg); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; line-height:1.6; }

#app { width: 100%; max-width: 640px; margin: 0 auto; padding: 12px 16px; }

/* Header */
[data-sticky="header"] {
  position: sticky; top: 0; z-index: 50;
  display: flex; align-items: center; justify-content: space-between;
  background: var(--bg);
  padding: 10px 12px; border-radius: 12px; border: 1px solid var(--border);
  box-shadow: 0 4px 24px -16px var(--ring);
  margin-bottom: 10px;
}
.app-header .header-title { display:flex; align-items:center; gap:10px; overflow:hidden; }
.app-header .brand { font-weight:700; color: var(--brand); letter-spacing: .2px; }
.app-header .title { font-weight:600; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }

.icon-btn {
  display:inline-flex; align-items:center; justify-content:center;
  width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--border);
  background: var(--card); color: var(--fg);
  transition: background .2s ease, transform .2s ease, border-color .2s ease;
}
.icon-btn:hover { background: #e9eef7; transform: translateY(-1px); }
html[data-theme="dark"] .icon-btn:hover { background: #121b2e; }

/* Progress Toolbar */
.progress-toolbar { padding: 4px 2px 12px 2px; }
.progress { display:flex; align-items:center; gap: 10px; }
.progress-track {
  position: relative;
  flex: 1 1 auto; height: 10px; background: var(--card); border: 1px solid var(--border); border-radius: 999px; overflow: hidden;
}
.progress-bar {
  position:absolute; left:0; top:0; bottom:0; width:0%;
  background: var(--bar);
  transition: width 250ms ease-in-out;
}
.progress-label { min-width: 72px; font-size: 12px; color: var(--muted); }

/* Main */
main#main { display:grid; gap: 16px; }
.card {
  background: var(--bg); border: 1px solid var(--border); border-radius: 16px;
  padding: 16px; box-shadow: 0 10px 30px -20px var(--ring);
}
.field { display:flex; flex-direction:column; gap: 8px; }
.field label { font-size: 13px; color: var(--muted); }
textarea, select, input[type="text"] {
  width:100%; padding: 12px 12px; border-radius: 12px; border: 1px solid var(--border);
  background: var(--card); color: var(--fg); resize: vertical;
  outline: none; transition: border-color .2s ease, box-shadow .2s ease;
}
textarea:focus, select:focus { border-color: var(--brand); box-shadow: 0 0 0 4px var(--ring); }

.grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }

.actions { display:flex; gap: 12px; flex-wrap: wrap; }
.btn {
  display:inline-flex; align-items:center; gap:10px;
  height: 42px; padding: 0 14px; border-radius: 12px; border: 1px solid var(--border);
  background: var(--card); color: var(--fg); font-weight:600; cursor:pointer;
  transition: transform .2s ease, background .2s ease, color .2s ease;
}
.btn:hover { transform: translateY(-1px); }
.btn.primary { background: var(--brand); color: #fff; border-color: rgba(255,255,255,.06); }
.btn.primary:hover { filter: brightness(1.05); }
.btn.ghost { background: transparent; }

.preview .preview-header {
  display:flex; align-items:center; justify-content:space-between; gap: 8px;
  margin-bottom: 10px;
}
.badge {
  display:inline-flex; align-items:center; padding: 4px 8px; border-radius: 999px;
  font-size: 11px; color: var(--muted); background: var(--card); border: 1px solid var(--border);
}
.preview-body { display:flex; }
.preview-pad {
  width:100%; background: var(--card); border: 1px dashed var(--border);
  border-radius: 12px; padding: 8px; display:flex; align-items:center; justify-content:center; min-height: 220px; position: relative;
}
.preview-pad img { max-width: 100%; height: auto; border-radius: 10px; display:none; }
.empty { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; color: var(--muted); text-align:center; padding: 24px 10px; }
.empty-art { opacity:.6; }

.preview-meta { margin-top: 10px; color: var(--muted); }

/* Footer */
[data-sticky="footer"] {
  position: sticky; bottom: 0; z-index: 40;
  background: var(--bg); border: 1px solid var(--border); border-radius: 16px;
  padding: 10px 12px; min-height: 44px; display:flex; flex-direction:column; gap:6px;
  margin-top: 10px;
}
.footer-nav { display:flex; align-items:center; justify-content:space-between; gap: 8px; flex-wrap: wrap; }
.footer-nav a { color: var(--fg); text-decoration: none; opacity:.9; font-size: 13px; }
.footer-nav a:hover { text-decoration: underline; }
.footer-brand { font-size: 12px; color: var(--muted); }

/* Modal */
.modal-overlay {
  position: fixed; inset:0; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px);
}
.modal {
  border: 1px solid var(--border); border-radius: 16px; width: min(520px, 92vw);
  padding: 0; background: var(--bg); color: var(--fg);
  position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
  box-shadow: 0 24px 80px -24px rgba(0,0,0,.35);
}
.modal::backdrop { background: transparent; }
.modal-header {
  display:flex; align-items:center; justify-content:space-between; padding: 14px 14px; border-bottom: 1px solid var(--border);
}
.modal-body { padding: 14px; }
.menu-list { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap: 8px; }
.menu-list a { display:block; padding: 10px 12px; border-radius: 12px; background: var(--card); border: 1px solid var(--border); color: var(--fg); text-decoration: none; }
.menu-list a:hover { background: #e9eef7; }
html[data-theme="dark"] .menu-list a:hover { background: #121b2e; }

/* Toast */
.toast-host { position: fixed; inset-inline: 0; bottom: 16px; display:flex; flex-direction:column; gap:8px; align-items:center; pointer-events:none; z-index: 60; }
.toast {
  pointer-events:auto; padding: 10px 12px; border-radius: 12px; background: var(--bg); border: 1px solid var(--border);
  box-shadow: 0 10px 30px -20px var(--ring);
  color: var(--fg); font-size: 13px; display:flex; align-items:center; gap: 10px;
}
.toast.success { border-color: #16a34a44; }
.toast.error { border-color: #ef444444; }
.toast .dot { width:8px; height:8px; border-radius:999px; }
.toast.success .dot { background:#16a34a; }
.toast.error .dot { background:#ef4444; }

/* Responsive */
@media (max-width:420px) {
  .grid-2 { grid-template-columns: 1fr; }
  .app-header .title { max-width: 52vw; }
  .btn span { font-size: 14px; }
  textarea { min-height: 96px; }
}
  </style>

  <!-- Monetag (WAJIB) -->
  <script src='//libtl.com/sdk.js' data-zone='9256839' data-sdk='show_9256839'></script>

  <!-- SaaS helper libraries (judul tidak mengandung (AI)) -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Optional ML/Media utils (placeholder CDN hooks) -->
  <script defer src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>
</head>
<body>
  <!-- App Container -->
  <div id="app">
    <!-- Header -->
    <header data-sticky="header" class="app-header">
      <button id="btnMenu" class="icon-btn" aria-label="Menu">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      <div class="header-title">
        <div class="brand">MDM</div>
        <div class="title" id="appTitle">AI Maker Teks To Image</div>
      </div>
      <button id="btnTheme" class="icon-btn" aria-label="Ganti Tema">
        <svg id="iconSun" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 4V2M12 22v-2M4.93 4.93L3.51 3.51M20.49 20.49l-1.42-1.42M22 12h-2M4 12H2M19.07 4.93l1.42-1.42M3.51 20.49l1.42-1.42M12 8a4 4 0 100 8 4 4 0 000-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <svg id="iconMoon" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="display:none">
          <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </header>

    <!-- Progress Bar (Toolbar Utama) -->
    <section class="progress-toolbar" aria-label="Bilah Progres">
      <div class="progress" id="loadingbar">
        <div class="progress-track">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="progress-label" id="progressLabel">Siap</div>
      </div>
    </section>

    <!-- Main -->
    <main id="main">
      <section class="card">
        <div class="field">
          <label for="promptInput">Teks Prompt</label>
          <textarea id="promptInput" rows="3" placeholder="Contoh: 'Kucing astronot lucu di galaksi berwarna neon, gaya kartun, warna cerah'"></textarea>
        </div>

        <div class="grid-2">
          <div class="field">
            <label for="ratioSelect">Rasio Gambar</label>
            <select id="ratioSelect">
              <option value="1:1">Persegi 1:1</option>
              <option value="16:9">Lanskap 16:9</option>
              <option value="9:16">Potret 9:16</option>
              <option value="4:3">Lanskap 4:3</option>
            </select>
          </div>
          <div class="field">
            <label for="qualitySelect">Kualitas</label>
            <select id="qualitySelect">
              <option value="768">Standar (768px)</option>
              <option value="1024">Tinggi (1024px)</option>
              <option value="512">Cepat (512px)</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <button id="btnGenerate" class="btn primary">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M5 12h14M12 5v14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span>Buat</span>
          </button>
          <button id="btnShare" class="btn ghost">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 12v7a1 1 0 001 1h14a1 1 0 001-1v-7M16 6l-4-4-4 4M12 2v14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span>Share</span>
          </button>
        </div>
      </section>

      <section class="card preview">
        <div class="preview-header">
          <span>Hasil Gambar (Base64)</span>
          <small id="providerBadge" class="badge">Provider: -</small>
        </div>
        <div class="preview-body">
          <div class="preview-pad">
            <img id="outputImage" alt="Pratinjau hasil AI (MDM)" />
            <div id="emptyState" class="empty">
              <div class="empty-art">
                <svg width="56" height="56" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M12 20l-6 2 2-6L2 8l6 2 2-6 2 6 6-2-4 8 6 2-8-4-4 6z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <p>Belum ada gambar. Tulis prompt dan klik “Buat”.</p>
            </div>
          </div>
        </div>
        <div class="preview-meta">
          <small>MDM (marilmu dot marepeng) — Semua hak cipta tertera pada kebijakan.</small>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer data-sticky="footer" class="app-footer">
      <nav class="footer-nav">
        <a href="#" data-open="profil">Profil</a>
        <a href="#" data-open="privacy">Privacy Policy</a>
        <a href="#" data-open="disclaimer">Disclaimer</a>
        <a href="mailto:marilmudotmarepeng@gmail.com" data-open="support">Hubungi Kami</a>
      </nav>
      <div class="footer-brand">© <span id="year"></span> MDM (marilmu dot marepeng)</div>
    </footer>
  </div>

  <!-- Modal / Overlay -->
  <div id="modalOverlay" class="modal-overlay" hidden></div>
  <dialog id="appModal" class="modal" aria-hidden="true">
    <div class="modal-header">
      <strong id="modalTitle">Menu</strong>
      <button id="btnModalClose" class="icon-btn" aria-label="Tutup">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="modal-body" id="modalBody">
      <ul class="menu-list">
        <li><a href="#" data-open="profil">Profil</a></li>
        <li><a href="#" data-open="privacy">Privacy Policy</a></li>
        <li><a href="#" data-open="disclaimer">Disclaimer</a></li>
        <li><a href="mailto:marilmudotmarepeng@gmail.com" data-open="support">Hubungi Kami</a></li>
      </ul>
    </div>
  </dialog>

  <!-- Toast -->
  <div id="toastHost" class="toast-host" aria-live="polite" aria-atomic="true"></div>

  <script>
    /* script.js — MDM (marilmu dot marepeng) • AI Maker Teks To Image */

/* ========= Global Constants ========= */
const AD_TIMEOUT_MS = 7000; // timeout tunggu iklan
const APP_NAME = "MDM • AI Maker Teks To Image";
const THEME_DARK = "#0A1F44";
const THEME_LIGHT = "#ffffff";
const PROVIDER_CHOICES = [
  "Pollinations.ai",
  "Craiyon",
  "HuggingFace SD",
  "Stable Horde",
  "OpenAssistant",
  "HuggingFace Transformers",
  "BLOOM",
  "GPT4All",
  "Cohere",
  "Anthropic Claude API",
  "Mistral AI",
  "LLaMA.cpp",
  "Vercel AI SDK",
  "OpenRouter AI",
  "GooseAI",
  "KoboldAI Horde",
  "DeepInfra",
  "Perplexity API",
  "Together.ai",
  "Fireworks.ai"
];

/* ========= DOM Refs ========= */
const $ = (q, root = document) => root.querySelector(q);
const $$ = (q, root = document) => Array.from(root.querySelectorAll(q));

const el = {
  title: $("#appTitle"),
  btnMenu: $("#btnMenu"),
  btnTheme: $("#btnTheme"),
  iconSun: $("#iconSun"),
  iconMoon: $("#iconMoon"),
  progressBar: $("#progressBar"),
  progressLabel: $("#progressLabel"),
  prompt: $("#promptInput"),
  ratio: $("#ratioSelect"),
  quality: $("#qualitySelect"),
  btnGenerate: $("#btnGenerate"),
  btnShare: $("#btnShare"),
  previewImg: $("#outputImage"),
  emptyState: $("#emptyState"),
  providerBadge: $("#providerBadge"),
  footerYear: $("#year"),
  modal: $("#appModal"),
  modalOverlay: $("#modalOverlay"),
  btnModalClose: $("#btnModalClose"),
  toastHost: $("#toastHost"),
  metaTheme: document.querySelector('meta[name="theme-color"]')
};

let lastImageDataURL = null;
let lastProviderUsed = null;

/* ========= Loading Bar API ========= */
const LoadingBar = (() => {
  let current = 0, timer = null;
  const setLabel = (text) => (el.progressLabel.textContent = text ?? "");
  const paint = (pct) => {
    current = Math.max(0, Math.min(100, pct|0));
    el.progressBar.style.width = `${current}%`;
  };
  const start = (label = "Memulai...") => {
    clearInterval(timer);
    paint(0); setLabel(label);
    // subtle auto progress until manual tick/finish
    timer = setInterval(() => {
      const next = current + Math.max(1, (100 - current) * 0.03);
      paint(Math.min(98, next));
    }, 260);
  };
  const tick = (delta = 10, label) => {
    if (label) setLabel(label);
    paint(Math.min(99, current + delta));
  };
  const finish = (label = "Selesai") => {
    clearInterval(timer);
    setLabel(label);
    requestAnimationFrame(() => paint(100));
    setTimeout(() => { paint(0); setLabel("Siap"); }, 400);
  };
  const fail = (label = "Gagal") => {
    clearInterval(timer);
    setLabel(label);
    requestAnimationFrame(() => paint(100));
    setTimeout(() => { paint(0); setLabel("Siap"); }, 600);
  };
  return { start, tick, setLabel, finish, fail };
})();

/* ========= Theme ========= */
function setTheme(mode) {
  const root = document.documentElement;
  root.setAttribute("data-theme", mode);
  if (mode === "dark") {
    el.iconSun.style.display = "none";
    el.iconMoon.style.display = "inline";
    if (el.metaTheme) el.metaTheme.setAttribute("content", THEME_DARK);
  } else {
    el.iconSun.style.display = "inline";
    el.iconMoon.style.display = "none";
    if (el.metaTheme) el.metaTheme.setAttribute("content", THEME_LIGHT);
  }
  try {
    // Telegram Mini App color sync
    if (window.Telegram?.WebApp?.setHeaderColor) {
      window.Telegram.WebApp.setHeaderColor(mode === "dark" ? "secondary_bg_color" : "bg_color");
    }
  } catch {}
}
function toggleTheme() {
  const curr = document.documentElement.getAttribute("data-theme") || "light";
  const next = curr === "light" ? "dark" : "light";
  setTheme(next);
  localStorage.setItem("mdm-theme", next);
}

/* ========= Providers & Pipeline ========= */
function parseTitle(title) {
  try {
    if (Array.isArray(title)) title = title.join(" ");
    return String(title || "").trim().replace(/\s+/g, " ").slice(0, 80);
  } catch { return "AI Maker Teks To Image"; }
}

async function discoverProviders(spec = "text-to-image") {
  // Urutkan prioritas: Pollinations → lainnya (fallback)
  const list = PROVIDER_CHOICES.map((name, idx) => ({
    id: name.toLowerCase().replace(/[^a-z0-9]+/g, "-"),
    name,
    rank: idx,
    capabilities: [spec]
  }));
  return list;
}

async function loadProviderClient(providerId) {
  // Hanya implementasi nyata untuk Pollinations; lainnya fallback ke canvas.
  if (providerId.startsWith("pollinations")) {
    return {
      id: providerId,
      async runTextToImage({ prompt, width, height }, onProgress) {
        onProgress?.(15, "Menghubungkan Pollinations...");
        const seed = Math.floor(Math.random() * 1e9);
        const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?seed=${seed}&width=${width}&height=${height}`;
        onProgress?.(45, "Menghasilkan gambar...");
        const resp = await fetch(url, { cache: "no-store" });
        if (!resp.ok) throw new Error("Gagal dari Pollinations");
        const blob = await resp.blob();
        onProgress?.(80, "Memproses hasil...");
        const dataURL = await blobToDataURL(blob);
        return { dataURL, provider: "Pollinations.ai" };
      }
    };
  }
  // Fallback: generate via Canvas (placeholder) agar selalu ada hasil.
  return {
    id: providerId,
    async runTextToImage({ prompt, width, height }, onProgress) {
      onProgress?.(25, "Fallback lokal...");
      const canvas = document.createElement("canvas");
      canvas.width = width; canvas.height = height;
      const ctx = canvas.getContext("2d");
      // background gradient
      const g = ctx.createLinearGradient(0, 0, width, height);
      g.addColorStop(0, "#0a1f44");
      g.addColorStop(1, "#2563eb");
      ctx.fillStyle = g; ctx.fillRect(0, 0, width, height);
      // overlay glass
      ctx.fillStyle = "rgba(255,255,255,0.05)";
      for (let i=0;i<8;i++) {
        ctx.beginPath();
        const r = Math.random()*Math.min(width,height)/3;
        ctx.arc(Math.random()*width, Math.random()*height, r, 0, Math.PI*2);
        ctx.fill();
      }
      // text
      const text = (prompt || "Gambar AI oleh MDM").trim();
      ctx.fillStyle = "#ffffff";
      ctx.shadowColor = "rgba(0,0,0,.3)";
      ctx.shadowBlur = 8;
      const fontSize = Math.max(18, Math.min(42, Math.round(width/22)));
      ctx.font = `600 ${fontSize}px Inter, system-ui, Arial`;
      wrapText(ctx, text, 40, 60, width - 80, fontSize * 1.4);

      // watermark
      ctx.shadowBlur = 0;
      ctx.fillStyle = "rgba(255,255,255,0.85)";
      ctx.font = `700 ${Math.max(12, Math.round(width/38))}px Inter, system-ui, Arial`;
      ctx.textAlign = "right";
      ctx.fillText("MDM • marilmu dot marepeng", width - 20, height - 20);

      onProgress?.(85, "Menyiapkan gambar...");
      const dataURL = canvas.toDataURL("image/png");
      return { dataURL, provider: "Fallback Canvas" };
    }
  };
}

function buildPipeline(capabilityKey = "text-to-image") {
  return {
    async run(input, settings, onProgress) {
      const providers = await discoverProviders(capabilityKey);
      // urutkan berdasarkan preferensi
      providers.sort((a,b) => a.rank - b.rank);

      let lastError = null;
      for (const p of providers) {
        const client = await loadProviderClient(p.id);
        try {
          onProgress?.(10, `Mencoba ${p.name}...`);
          const result = await client.runTextToImage({
            prompt: input.prompt,
            width: input.width,
            height: input.height
          }, (pct, label) => onProgress?.(pct, label ?? `Menggunakan ${p.name}...`));
          if (result?.dataURL) {
            return { ...result, provider: result.provider ?? p.name };
          }
        } catch (e) {
          lastError = e;
          // lanjut ke provider berikutnya
        }
      }
      throw lastError ?? new Error("Semua provider gagal.");
    }
  };
}

/* ========= Monetag Integration ========= */
function monetagReady() {
  return new Promise((resolve, reject) => {
    const started = Date.now();
    const check = () => {
      if (typeof window.show_9256839 === "function") {
        resolve(true); return;
      }
      if (Date.now() - started > AD_TIMEOUT_MS) {
        reject(new Error("Monetag tidak siap"));
      } else {
        setTimeout(check, 150);
      }
    };
    check();
  });
}

/** Jalankan aksi dalam konteks iklan Monetag reward */
async function withMonetagInApp(actionFn) {
  try {
    await monetagReady();
    // panggil iklan; asumsi resolved bila fungsi tersedia
    let adOk = false;
    try {
      // panggil iklan; tidak memblokir UI
      show_9256839(); // memastikan keyword "show_9256839(" ada
      adOk = true;
    } catch (e) {
      adOk = false;
    }
    await new Promise(r => setTimeout(r, 1200)); // jeda agar iklan tampil
    if (!adOk) {
      showToast("Gagal memuat iklan, coba lagi.", "error");
      return;
    }
    await actionFn?.();
  } catch (e) {
    showToast("Gagal memuat iklan, coba lagi.", "error");
  }
}

/* ========= Actions ========= */
async function onGenerateClick() {
  await withMonetagInApp(async () => {
    const prompt = (el.prompt.value || "").trim();
    if (!prompt) {
      showToast("Tolong tulis prompt terlebih dahulu.", "error");
      return;
    }
    lockToolbarButtons();

    const { width, height } = chooseDimensions(el.ratio.value, parseInt(el.quality.value, 10));
    const pipeline = buildPipeline("text-to-image");

    LoadingBar.start("Menyiapkan...");
    try {
      const result = await pipeline.run(
        { prompt, width, height },
        {},
        (pct, label) => { LoadingBar.tick(0, label); }
      );
      lastImageDataURL = result.dataURL;
      lastProviderUsed = result.provider || "-";
      updatePreview(lastImageDataURL);
      updateProviderBadge(lastProviderUsed);
      LoadingBar.finish("Selesai");
      showToast("Gambar berhasil dibuat ✅", "success");
    } catch (e) {
      console.error(e);
      LoadingBar.fail("Gagal");
      showToast("Proses gagal, coba ganti prompt atau kualitas.", "error");
    } finally {
      unlockToolbarButtons();
    }
  });
}

async function onShareClick() {
  await withMonetagInApp(async () => {
    if (!lastImageDataURL) {
      showToast("Belum ada gambar untuk dibagikan.", "error");
      return;
    }
    LoadingBar.start("Menyiapkan berbagi...");
    try {
      const blob = dataURLtoBlob(lastImageDataURL);
      const file = new File([blob], "mdm-image.png", { type: "image/png" });
      const shareData = {
        title: "MDM • Gambar AI",
        text: "Dibuat dengan MDM (marilmu dot marepeng).",
        files: [file]
      };

      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share(shareData); // memastikan keyword "navigator.share(" ada
        LoadingBar.finish("Dibagikan");
        showToast("Berhasil dibagikan.", "success");
      } else if (navigator.share) {
        await navigator.share({ title: "MDM • Gambar AI", text: "Lihat gambar dari MDM." });
        LoadingBar.finish("Dibagikan");
        showToast("Berhasil dibagikan.", "success");
      } else {
        LoadingBar.fail("Gagal");
        showToast("Tap & tahan gambar untuk menyimpan ke perangkat.", "error");
      }
    } catch (e) {
      console.error(e);
      LoadingBar.fail("Gagal");
      showToast("Tap & tahan gambar untuk menyimpan ke perangkat.", "error");
    }
  });
}

function onSupportClick() {
  window.location.href = "mailto:marilmudotmarepeng@gmail.com";
}

/* ========= UI Helpers ========= */
function updatePreview(dataURL) {
  if (dataURL) {
    el.previewImg.src = dataURL;
    el.previewImg.style.display = "block";
    el.emptyState.style.display = "none";
  } else {
    el.previewImg.removeAttribute("src");
    el.previewImg.style.display = "none";
    el.emptyState.style.display = "flex";
  }
}
function updateProviderBadge(name) {
  el.providerBadge.textContent = `Provider: ${name || "-"}`;
}
function chooseDimensions(ratio, base = 768) {
  const max = base;
  let w = max, h = max;
  const [a, b] = ratio.split(":").map(Number);
  if (a && b) {
    if (a >= b) {
      w = max; h = Math.round((max * b) / a);
    } else {
      h = max; w = Math.round((max * a) / b);
    }
  }
  // pastikan genap
  w = w - (w % 2); h = h - (h % 2);
  return { width: w, height: h };
}

function lockToolbarButtons() {
  el.btnGenerate.disabled = true;
  el.btnShare.disabled = true;
  el.btnGenerate.classList.add("is-loading");
}
function unlockToolbarButtons() {
  el.btnGenerate.disabled = false;
  el.btnShare.disabled = false;
  el.btnGenerate.classList.remove("is-loading");
}

function showModal(idOrCfg) {
  const overlay = el.modalOverlay;
  const dialog = el.modal;
  overlay.hidden = false;

  if (typeof idOrCfg === "object" && idOrCfg) {
    $("#modalTitle").textContent = idOrCfg.title || "Info";
    $("#modalBody").innerHTML = idOrCfg.body || "";
  } else {
    $("#modalTitle").textContent = "Menu";
    $("#modalBody").innerHTML = `
      <ul class="menu-list">
        <li><a href="#" data-open="profil">Profil</a></li>
        <li><a href="#" data-open="privacy">Privacy Policy</a></li>
        <li><a href="#" data-open="disclaimer">Disclaimer</a></li>
        <li><a href="mailto:marilmudotmarepeng@gmail.com" data-open="support">Hubungi Kami</a></li>
      </ul>
    `;
  }
  dialog.showModal();
  dialog.setAttribute("aria-hidden", "false");
}
function closeModal() {
  el.modalOverlay.hidden = true;
  el.modal.close();
  el.modal.setAttribute("aria-hidden", "true");
}

function showToast(message, type = "success", timeout = 2600) {
  const wrap = document.createElement("div");
  wrap.className = `toast ${type}`;
  wrap.innerHTML = `<span class="dot"></span><span>${message}</span>`;
  el.toastHost.appendChild(wrap);
  setTimeout(() => {
    wrap.style.transform = "translateY(-6px)";
    wrap.style.opacity = "0";
    setTimeout(() => wrap.remove(), 300);
  }, timeout);
}

function downloadBlob(blob, filename = "file.bin", mime = "application/octet-stream") {
  // memastikan keyword "downloadBlob(" ada
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename; a.rel = "noopener";
  document.body.appendChild(a);
  a.click();
  setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
}

/* ========= Utils ========= */
function blobToDataURL(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}
function dataURLtoBlob(dataurl) {
  const arr = dataurl.split(",");
  const mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]);
  let n = bstr.length; const u8arr = new Uint8Array(n);
  while (n--) u8arr[n] = bstr.charCodeAt(n);
  return new Blob([u8arr], { type: mime });
}
function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
  const words = text.split(/\s+/);
  let line = "", yy = y;
  for (let n = 0; n < words.length; n++) {
    const test = line + words[n] + " ";
    const w = ctx.measureText(test).width;
    if (w > maxWidth && n > 0) {
      ctx.fillText(line, x, yy);
      line = words[n] + " ";
      yy += lineHeight;
    } else {
      line = test;
    }
  }
  ctx.fillText(line, x, yy);
}

/* ========= Preflight ========= */
function runPreflightChecks() {
  // Verifikasi minimal runtime
  const okMeta = !!el.metaTheme;
  const okMonetagTag = !!document.querySelector("script[src*='libtl.com']");
  if (!okMeta || !okMonetagTag) {
    console.warn("Preflight: meta theme-color / Monetag snippet mungkin tidak ditemukan.");
  }
  // Log providers
  console.info("Providers default (20):", PROVIDER_CHOICES);
  return true;
}

/* ========= Init ========= */
async function initApp({ title, options } = {}) {
  try {
    // Telegram WebApp adapt
    if (window.Telegram?.WebApp) {
      window.Telegram.WebApp.ready();
      window.Telegram.WebApp.expand();
    }
  } catch {}

  el.footerYear.textContent = new Date().getFullYear();
  el.title.textContent = parseTitle(title) || "AI Maker Teks To Image";

  // theme
  const savedTheme = localStorage.getItem("mdm-theme") || "light";
  setTheme(savedTheme);

  // events
  el.btnTheme.addEventListener("click", toggleTheme);
  el.btnMenu.addEventListener("click", () => showModal("menu"));
  el.btnModalClose.addEventListener("click", closeModal);
  el.modalOverlay.addEventListener("click", closeModal);

  // menu link handlers (header and footer share)
  const handleOpen = (key) => {
    if (key === "profil") {
      showModal({ title: "Profil MDM", body: `
        <p><strong>MDM (marilmu dot marepeng)</strong> adalah platform SaaS minimalis untuk kreator Indonesia. 
        Aplikasi ini mengubah <em>teks menjadi gambar AI</em> secara cepat dan elegan.</p>
        <p>Brand & UI dirancang setara Figma/Notion untuk pengalaman premium.</p>` });
    } else if (key === "privacy") {
      showModal({ title: "Kebijakan Privasi", body: `
        <p>Kami tidak menyimpan prompt Anda di server. Data hanya diproses untuk menghasilkan gambar.</p>
        <ul>
          <li>Cookie hanya untuk preferensi tema.</li>
          <li>Penyedia AI pihak ketiga memiliki kebijakan tersendiri.</li>
        </ul>` });
    } else if (key === "disclaimer") {
      showModal({ title: "Disclaimer", body: `
        <p>Hasil AI dapat mengandung ketidakakuratan. Gunakan secara bertanggung jawab.</p>
        <p>Semua merek dagang dimiliki oleh pemiliknya masing-masing.</p>` });
    } else if (key === "support") {
      onSupportClick();
    }
  };
  document.body.addEventListener("click", (e) => {
    const a = e.target.closest("[data-open]");
    if (a) {
      e.preventDefault();
      handleOpen(a.getAttribute("data-open"));
    }
  });

  el.btnGenerate.addEventListener("click", onGenerateClick);
  el.btnShare.addEventListener("click", onShareClick);

  // placeholder
  updatePreview(null);

  runPreflightChecks();
}

/* ========= Boot ========= */
document.addEventListener("DOMContentLoaded", () => {
  initApp({ title: "AI Maker Teks To Image" });
});
  </script>
</body>
</html>
