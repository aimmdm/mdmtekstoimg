<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>AI Maker Teks To Image — MDM</title>
  <meta name="application-name" content="AI Maker Teks To Image — MDM" />
  <meta name="description" content="AI Maker Teks To Image oleh MDM (marilmu dot marepeng) — Telegram Mini App SPA premium untuk membuat gambar dari teks dengan fallback 20 penyedia AI." />
  <meta name="theme-color" content="#ffffff" />
  <meta property="og:title" content="AI Maker Teks To Image — MDM" />
  <meta property="og:description" content="Buat gambar dari teks secara instan. Fallback 20 penyedia AI. Milik MDM (marilmu dot marepeng)." />
  <meta property="og:type" content="website" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='100%25' height='100%25' fill='%230A1F44'/%3E%3Ctext x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='system-ui' font-size='28'%3EMDM%3C/text%3E%3C/svg%3E" />
  <!-- Monetag (WAJIB) -->
  <script src='//libtl.com/sdk.js' data-zone='9256839' data-sdk='show_9256839'></script>
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
  --mdm-blue: #0A1F44;
  --bg: #ffffff;
  --fg: #0B1220;
  --muted: #6b7280;
  --card: #f8fafc;
  --border: #e5e7eb;
  --shadow: 0 8px 24px rgba(0,0,0,0.08);
  --radius: 14px;
  --accent: #2563eb;
  --accent-2: #10b981;
  --danger: #ef4444;
  --progress: linear-gradient(90deg, #2563eb, #10b981);
}

html[data-theme="dark"] {
  --bg: var(--mdm-blue);
  --fg: #e8eefc;
  --muted: #b0bdd6;
  --card: #0f2b66;
  --border: #163264;
  --shadow: 0 8px 24px rgba(0,0,0,0.3);
}

* { box-sizing: border-box; }
html, body { height: 100%; }
body { display:flex; flex-direction:column; margin:0; background:var(--bg); color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }

.container { width:100%; max-width:640px; margin:0 auto; padding:0 16px; }

.app-shell { width:100%; min-height:100vh; }

/* Header sticky/fixed */
[data-sticky="header"] {
  position: fixed;
  top: 0; left: 0; right:0;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  z-index: 40;
  box-shadow: 0 6px 18px rgba(0,0,0,0.04);
  margin-bottom: 10px;
}
.header-inner {
  height: 64px;
  display:flex; align-items:center; justify-content:space-between;
  gap:12px;
}
.brand { display:flex; flex-direction:column; line-height:1.1; }
.brand .title { font-weight:700; letter-spacing:.2px; }
.brand .subtitle { font-size:12px; color:var(--muted); }

/* Progress Bar (toolbar utama) */
.progress-toolbar {
  width:100%;
  border-top: 1px solid var(--border);
  background: transparent;
}
.progress-track {
  height: 4px;
  width:100%;
  background: rgba(0,0,0,0.06);
  position:relative;
}
html[data-theme="dark"] .progress-track { background: rgba(255,255,255,0.12); }
.progress-bar {
  height:100%;
  width:0%;
  background: var(--progress);
  transition: width 250ms ease;
}
.progress-label {
  font-size: 12px;
  color: var(--muted);
  padding: 6px 16px 10px;
}

/* Main content spacing */
.main-content {
  padding-top: 64px; /* header height */
  margin-top: 10px;
  padding-bottom: 96px; /* footer space */
  display:flex; flex-direction:column; gap:24px;
}

/* Card */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 20px;
}
.card-header { margin-bottom: 10px; }
.card-title { margin:0 0 4px; font-size: 18px; }
.card-subtitle { margin:0; color: var(--muted); font-size: 13px; }

/* Form */
.field { display:flex; flex-direction:column; gap:8px; }
.field label { font-size: 13px; color: var(--muted); }
textarea, select, input[type="text"] {
  background: #ffffff;
  color: #0b1220;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 14px;
  outline: none;
  transition: border-color .2s ease, box-shadow .2s ease;
}
html[data-theme="dark"] textarea,
html[data-theme="dark"] select,
html[data-theme="dark"] input[type="text"] {
  background: rgba(255,255,255,0.06);
  color: var(--fg);
  border-color: #294578;
}
textarea:focus, select:focus, input[type="text"]:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(37,99,235,0.12);
}
.grid { display:flex; flex-direction:column; gap:16px; }
.row { display:flex; align-items:stretch; }
.row.gap { gap:16px; }
.row.actions { gap:12px; }

/* Buttons */
.btn {
  border:0; outline:0; border-radius: 12px;
  padding: 12px 14px; display:inline-flex; gap:8px; align-items:center; justify-content:center;
  font-weight:600; cursor:pointer;
  transition: transform .08s ease, background .2s ease, box-shadow .2s ease, opacity .2s ease;
  box-shadow: 0 6px 16px rgba(0,0,0,0.08);
}
.btn svg { fill: currentColor; stroke: currentColor; }
.btn:active { transform: translateY(1px); }
.btn.primary { background: linear-gradient(135deg, var(--accent), #3b82f6); color: white; }
.btn.secondary { background: linear-gradient(135deg, var(--accent-2), #22c55e); color: white; }
.btn[disabled] { opacity: .6; cursor:not-allowed; box-shadow: none; }

.icon-btn {
  background: transparent; border:1px solid var(--border);
  border-radius: 12px; padding: 8px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center;
  transition: background .2s ease, border-color .2s ease, transform .08s ease;
}
.icon-btn:hover { background: rgba(0,0,0,0.04); }
html[data-theme="dark"] .icon-btn:hover { background: rgba(255,255,255,0.06); }
.icon-btn:active { transform: translateY(1px); }
.icon-btn svg { stroke: currentColor; fill: none; }

/* Preview */
.preview-card { }
.preview-header { margin-bottom: 10px; }
.preview {
  position: relative; background: #fff; border-radius: 12px; border: 1px dashed var(--border);
  min-height: 220px; display:flex; align-items:center; justify-content:center; padding: 8px;
}
html[data-theme="dark"] .preview { background: rgba(255,255,255,0.04); }
.placeholder { color: var(--muted); text-align:center; display:flex; flex-direction:column; align-items:center; gap:8px; }
.placeholder svg { stroke: var(--muted); fill: none; opacity:.8; }
.result-img { max-width: 100%; border-radius: 10px; display:block; }

/* Footer sticky/fixed */
[data-sticky="footer"] {
  position: fixed; left:0; right:0; bottom:0;
  background: var(--bg);
  border-top: 1px solid var(--border);
  z-index: 30;
  margin-top: 10px;
}
.footer-nav {
  min-height: 56px; display:flex; align-items:center; justify-content:space-between; gap:12px;
}
.footer-nav a {
  color: var(--fg); text-decoration:none; font-size: 13px; border: 1px solid var(--border);
  padding: 8px 12px; border-radius: 12px; background: var(--card);
  transition: background .2s ease, border-color .2s ease;
}
.footer-nav a:hover { background: #fff; }
html[data-theme="dark"] .footer-nav a:hover { background: rgba(255,255,255,0.06); }

/* Modal / Bottom Sheet (centered) */
.modal-overlay {
  position: fixed; inset:0; background: rgba(0,0,0,0.4); z-index: 50;
}
.modal {
  position: fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index: 60;
}
.modal[hidden], .modal-overlay[hidden] { display:none; }
.modal-content {
  width: calc(100% - 32px); max-width: 520px;
  background: var(--bg); border:1px solid var(--border);
  border-radius: 16px; box-shadow: var(--shadow);
  overflow: hidden;
}
.modal-header {
  display:flex; align-items:center; justify-content:space-between; padding: 14px 16px; border-bottom:1px solid var(--border);
}
.modal-body { padding: 14px 16px; }
.menu-list { list-style:none; padding:0; margin:0 0 8px 0; display:flex; flex-direction:column; gap:10px; }
.menu-list a { color: var(--fg); text-decoration:none; }
.muted { color: var(--muted); font-size: 12px; }

/* Toast */
.toast {
  position: fixed; left:50%; bottom: 76px; transform: translateX(-50%);
  background: #111827; color: #fff;
  padding: 10px 14px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,.2);
  max-width: calc(100% - 32px); z-index: 70; opacity: 0; pointer-events: none; transition: opacity .2s ease, transform .2s ease;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(-6px); }
.toast.success { background: #065f46; } /* teal-900 */
.toast.error { background: #7f1d1d; } /* red-900 */
.toast.info { background: #111827; } /* gray-900 */

/* Responsive */
@media (max-width:420px) {
  .header-inner { height: 60px; }
  .brand .title { font-size: 15px; }
  .footer-nav { flex-wrap: wrap; gap:8px; padding: 8px 0; }
  .row.actions { flex-direction: column; }
  .row.gap { flex-direction: column; }
}    
</style>
</head>
<body>
  <div class="app-shell">
    <!-- Header -->
    <header data-sticky="header">
      <div class="container header-inner">
        <button id="btnMenu" class="icon-btn" aria-label="Buka menu" title="Menu">
          <svg width="24" height="24" viewBox="0 0 24 24" aria-hidden="true">
            <rect x="3" y="5" width="18" height="2" rx="1"></rect>
            <rect x="3" y="11" width="18" height="2" rx="1"></rect>
            <rect x="3" y="17" width="18" height="2" rx="1"></rect>
          </svg>
        </button>
        <div class="brand">
          <div class="title">AI Maker Teks To Image</div>
          <div class="subtitle">MDM (marilmu dot marepeng)</div>
        </div>
        <button id="btnTheme" class="icon-btn" aria-label="Ubah tema" title="Tema">
          <svg id="iconSun" width="24" height="24" viewBox="0 0 24 24" aria-hidden="true">
            <circle cx="12" cy="12" r="4"></circle>
            <g stroke-width="2" stroke-linecap="round">
              <line x1="12" y1="1" x2="12" y2="4"></line>
              <line x1="12" y1="20" x2="12" y2="23"></line>
              <line x1="1" y1="12" x2="4" y2="12"></line>
              <line x1="20" y1="12" x2="23" y2="12"></line>
              <line x1="4.2" y1="4.2" x2="6.3" y2="6.3"></line>
              <line x1="17.7" y1="17.7" x2="19.8" y2="19.8"></line>
              <line x1="4.2" y1="19.8" x2="6.3" y2="17.7"></line>
              <line x1="17.7" y1="6.3" x2="19.8" y2="4.2"></line>
            </g>
          </svg>
          <svg id="iconMoon" width="24" height="24" viewBox="0 0 24 24" aria-hidden="true" style="display:none">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
        </button>
      </div>
      <!-- Progress Bar (Toolbar utama tunggal) -->
      <div id="progressToolbar" class="progress-toolbar">
        <div class="progress-track">
          <div id="progressBar" class="progress-bar"></div>
        </div>
        <div id="progressLabel" class="progress-label">Siap</div>
      </div>
    </header>

    <!-- Main -->
    <main id="main" class="container main-content">
      <section class="card">
        <div class="card-header">
          <h1 class="card-title">Pembuat Gambar dari Teks (AI)</h1>
          <p class="card-subtitle">Masukkan deskripsi, pilih gaya dan penyedia AI. Aplikasi akan otomatis fallback ke 20 penyedia jika ada kendala.</p>
        </div>

        <div class="grid">
          <div class="field">
            <label for="prompt">Deskripsi Teks</label>
            <textarea id="prompt" rows="3" placeholder="Contoh: kucing astronot bergaya digital art, pencahayaan sinematik, 4k"></textarea>
          </div>

          <div class="row gap">
            <div class="field">
              <label for="style">Gaya</label>
              <select id="style">
                <option value="auto" selected>Otomatis</option>
                <option value="photoreal">Fotorealistik</option>
                <option value="digital-art">Digital Art</option>
                <option value="anime">Anime</option>
                <option value="comic">Komik</option>
                <option value="oil-painting">Lukisan Minyak</option>
              </select>
            </div>
            <div class="field">
              <label for="ratio">Rasio</label>
              <select id="ratio">
                <option value="1:1" selected>1:1 (Persegi)</option>
                <option value="3:4">3:4 (Potret)</option>
                <option value="4:3">4:3 (Lanskap)</option>
                <option value="16:9">16:9 (Wide)</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label for="provider">Penyedia AI</label>
            <select id="provider">
              <option value="auto" selected>Otomatis (20 penyedia)</option>
            </select>
          </div>

          <div class="row actions">
            <button id="btnGenerate" class="btn primary">
              <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M8 5v14l11-7z"></path>
              </svg>
              <span>Buat</span>
            </button>
            <button id="btnShare" class="btn secondary" disabled>
              <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7"></path>
                <path d="M16 6l-4-4-4 4"></path>
                <path d="M12 2v14"></path>
              </svg>
              <span>Share</span>
            </button>
          </div>
        </div>
      </section>

      <section class="card preview-card">
        <div class="preview-header">
          <h2 class="card-title">Pratinjau</h2>
          <p class="card-subtitle">Semua gambar pratinjau bersifat Base64 Image.</p>
        </div>
        <div id="preview" class="preview">
          <div id="placeholder" class="placeholder">
            <svg width="42" height="42" viewBox="0 0 24 24" aria-hidden="true">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <path d="M21 15l-5-5L5 21"></path>
            </svg>
            <p>Belum ada gambar. Tulis prompt dan klik Buat.</p>
          </div>
          <img id="resultImg" alt="Hasil gambar AI" class="result-img" style="display:none" />
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer data-sticky="footer">
      <nav class="container footer-nav">
        <a href="#" data-link="profil">Profil</a>
        <a href="#" data-link="privacy">Privacy Policy</a>
        <a href="#" data-link="disclaimer">Disclaimer</a>
        <a href="mailto:marilmudotmarepeng@gmail.com">Hubungi Kami</a>
      </nav>
    </footer>
  </div>

  <!-- Modal Menu -->
  <div id="modalOverlay" class="modal-overlay" hidden></div>
  <div id="modalMenu" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" hidden>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Menu</h3>
        <button class="icon-btn" id="btnCloseModal" aria-label="Tutup">
          <svg width="22" height="22" viewBox="0 0 24 24">
            <path d="M18 6L6 18"></path>
            <path d="M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <ul class="menu-list">
          <li><a href="#" data-link="profil">Profil</a></li>
          <li><a href="#" data-link="privacy">Privacy Policy</a></li>
          <li><a href="#" data-link="disclaimer">Disclaimer</a></li>
          <li><a href="mailto:marilmudotmarepeng@gmail.com">Hubungi Kami</a></li>
        </ul>
        <p class="muted">Semua perangkat lunak adalah milik MDM (marilmu dot marepeng).</p>
      </div>
    </div>
  </div>

  <!-- Modal Static Pages -->
  <div id="modalPage" class="modal" role="dialog" aria-modal="true" hidden>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalPageTitle">Judul</h3>
        <button class="icon-btn" id="btnClosePage" aria-label="Tutup">
          <svg width="22" height="22" viewBox="0 0 24 24">
            <path d="M18 6L6 18"></path>
            <path d="M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div id="modalPageBody" class="modal-body"></div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* AI Maker Teks To Image — MDM (marilmu dot marepeng)
   Telegram Mini App SPA
   - Progress Bar API: start(), tick(), setLabel(), finish(), fail()
   - Monetag Reward Gate
   - 20 penyedia AI dengan auto fallback
*/

(() => {
  'use strict';

  // ---------- Config ----------
  const APP_TITLE = 'AI Maker Teks To Image';
  const BRAND = 'MDM (marilmu dot marepeng)';
  const THEME_LIGHT = '#ffffff';
  const THEME_DARK = '#0A1F44';
  const AD_TIMEOUT_MS = 10000; // AD_TIMEOUT_MS (wajib ada)
  const DEFAULT_WIDTH = 768;
  const DEFAULT_HEIGHT = 768;

  // 20 Default AI Providers (wajib)
  const PROVIDER_CHOICES = [
    { id: 'pollinations', name: 'Pollinations.ai', capability: ['text-to-image'] },
    { id: 'craiyon', name: 'Craiyon', capability: ['text-to-image'] },
    { id: 'hf-sd', name: 'HuggingFace SD', capability: ['text-to-image'] },
    { id: 'stable-horde', name: 'Stable Horde', capability: ['text-to-image'] },
    { id: 'openassistant', name: 'OpenAssistant', capability: ['chat', 'text-to-image'] },
    { id: 'hf-transformers', name: 'HuggingFace Transformers', capability: ['nlp', 'text-to-image'] },
    { id: 'bloom', name: 'BLOOM', capability: ['nlp'] },
    { id: 'gpt4all', name: 'GPT4All', capability: ['nlp'] },
    { id: 'cohere', name: 'Cohere', capability: ['nlp'] },
    { id: 'anthropic', name: 'Anthropic Claude API', capability: ['nlp'] },
    { id: 'mistral', name: 'Mistral AI', capability: ['nlp'] },
    { id: 'llama-cpp', name: 'LLaMA.cpp', capability: ['nlp'] },
    { id: 'vercel-ai', name: 'Vercel AI SDK', capability: ['nlp','routing'] },
    { id: 'openrouter', name: 'OpenRouter AI', capability: ['nlp'] },
    { id: 'gooseai', name: 'GooseAI', capability: ['nlp'] },
    { id: 'kobold-horde', name: 'KoboldAI Horde', capability: ['text-to-image'] },
    { id: 'deepinfra', name: 'DeepInfra', capability: ['nlp','image'] },
    { id: 'perplexity', name: 'Perplexity API', capability: ['search','nlp'] },
    { id: 'together', name: 'Together.ai', capability: ['nlp','image'] },
    { id: 'fireworks', name: 'Fireworks.ai', capability: ['nlp','image'] },
  ];

  const els = {
    btnMenu: document.getElementById('btnMenu'),
    btnCloseModal: document.getElementById('btnCloseModal'),
    btnClosePage: document.getElementById('btnClosePage'),
    btnTheme: document.getElementById('btnTheme'),
    btnGenerate: document.getElementById('btnGenerate'),
    btnShare: document.getElementById('btnShare'),
    provider: document.getElementById('provider'),
    style: document.getElementById('style'),
    ratio: document.getElementById('ratio'),
    prompt: document.getElementById('prompt'),
    preview: document.getElementById('preview'),
    placeholder: document.getElementById('placeholder'),
    resultImg: document.getElementById('resultImg'),
    modalOverlay: document.getElementById('modalOverlay'),
    modalMenu: document.getElementById('modalMenu'),
    modalPage: document.getElementById('modalPage'),
    modalPageTitle: document.getElementById('modalPageTitle'),
    modalPageBody: document.getElementById('modalPageBody'),
    toast: document.getElementById('toast'),
    progressBar: document.getElementById('progressBar'),
    progressLabel: document.getElementById('progressLabel'),
  };

  // Telegram integration (polyfill for local dev)
  const Telegram = window.Telegram || {};
  if (!Telegram.WebApp) {
    Telegram.WebApp = {
      colorScheme: 'light',
      isExpanded: true,
      platform: 'web',
      initDataUnsafe: {},
      MainButton: { show: () => {}, hide: () => {} },
      HapticFeedback: { impactOccurred: () => {}, notificationOccurred: () => {} },
      setBackgroundColor: () => {},
      setHeaderColor: () => {},
      shareToStory: (...args) => { console.log('Telegram.WebApp.shareToStory()', ...args); }, // Telegram.WebApp.shareToStory()
      openLink: (url) => { window.open(url, '_blank'); }, // Telegram.WebApp.openLink()
      ready: () => {},
      expand: () => {},
      close: () => {},
    };
  }

  // ---------- Utility: Theme ----------
  function setMetaThemeColor(hex) {
    const meta = document.querySelector('meta[name="theme-color"]');
    if (meta) meta.setAttribute('content', hex);
  }
  function toggleTheme() {
    const html = document.documentElement;
    const next = html.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
    html.setAttribute('data-theme', next);
    const dark = next === 'dark';
    document.getElementById('iconSun').style.display = dark ? 'none' : 'block';
    document.getElementById('iconMoon').style.display = dark ? 'block' : 'none';
    setMetaThemeColor(dark ? THEME_DARK : THEME_LIGHT);
    try { localStorage.setItem('mdm_theme', next); } catch {}
  }
  function initTheme() {
    const saved = (() => { try { return localStorage.getItem('mdm_theme'); } catch { return null; } })();
    const mode = saved || 'light';
    document.documentElement.setAttribute('data-theme', mode);
    const dark = mode === 'dark';
    document.getElementById('iconSun').style.display = dark ? 'none' : 'block';
    document.getElementById('iconMoon').style.display = dark ? 'block' : 'none';
    setMetaThemeColor(dark ? THEME_DARK : THEME_LIGHT);
  }

  // ---------- Loading Bar API ----------
  const LoadingBar = (() => {
    let value = 0;
    let running = false;
    function setWidth(p) {
      els.progressBar.style.width = `${p}%`;
    }
    return {
      start(label = 'Memulai...') {
        running = true;
        value = 0;
        setWidth(0);
        this.setLabel(label);
      },
      tick(delta = 5) {
        if (!running) return;
        value = Math.min(99, value + delta);
        setWidth(value);
      },
      setLabel(text) {
        els.progressLabel.textContent = text;
      },
      finish(label = 'Selesai') {
        running = false;
        value = 100;
        setWidth(100);
        this.setLabel(label);
        setTimeout(() => {
          // reset after small delay
          value = 0;
          setWidth(0);
          this.setLabel('Siap');
        }, 600);
      },
      fail(errorLabel = 'Gagal') {
        running = false;
        value = 100;
        setWidth(100);
        this.setLabel(errorLabel);
        setTimeout(() => {
          value = 0;
          setWidth(0);
          this.setLabel('Siap');
        }, 1200);
      }
    };
  })();

  // ---------- Toast ----------
  function showToast(msg, type = 'info', timeout = 3000) { // showToast
    const t = els.toast;
    t.textContent = msg;
    t.className = `toast show ${type}`;
    setTimeout(() => { t.className = 'toast'; }, timeout);
  }

  // ---------- Modal ----------
  function showModal(idOrCfg) { // showModal
    let target = null;
    if (typeof idOrCfg === 'string') {
      target = document.getElementById(idOrCfg);
    }
    if (!target) return;
    els.modalOverlay.hidden = false;
    target.hidden = false;
    // Close by overlay click
    els.modalOverlay.onclick = () => closeModal(target.id);
  }
  function closeModal(id) { // closeModal
    if (!id) return;
    const target = document.getElementById(id);
    if (!target) return;
    target.hidden = true;
    els.modalOverlay.hidden = true;
    els.modalOverlay.onclick = null;
  }

  // ---------- Toolbar buttons lock/unlock ----------
  function lockToolbarButtons() { // lockToolbarButtons
    els.btnGenerate.setAttribute('disabled', 'true');
    els.btnShare.setAttribute('disabled', 'true');
  }
  function unlockToolbarButtons() { // unlockToolbarButtons
    els.btnGenerate.removeAttribute('disabled');
    if (state.lastDataUrl) els.btnShare.removeAttribute('disabled');
  }

  // ---------- File / Blob helper ----------
  async function blobToDataURL(blob) {
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);
      fr.onerror = reject;
      fr.readAsDataURL(blob);
    });
  }
  function downloadBlob(blob, filename = 'mdm-ai.png', mime = 'image/png') { // downloadBlob(
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      URL.revokeObjectURL(url);
      a.remove();
    }, 1000);
  }

  // ---------- Monetag ----------
  function monetagReady() { // monetagReady
    return new Promise((resolve, reject) => {
      const start = Date.now();
      (function waitForFn() {
        if (typeof window.show_9256839 === 'function') return resolve(true);
        if (Date.now() - start > AD_TIMEOUT_MS) return reject(new Error('Monetag timeout'));
        setTimeout(waitForFn, 200);
      })();
    });
  }

  async function withMonetagInApp(callback, label = 'Iklan') { // withMonetagInApp(
    try {
      await monetagReady();
    } catch (e) {
      showToast('Gagal memuat iklan, coba lagi.', 'error', 3000);
      throw e;
    }
    return new Promise((resolve, reject) => {
      let finished = false;
      const timeoutId = setTimeout(() => {
        if (!finished) {
          showToast('Gagal memuat iklan, coba lagi.', 'error', 3000);
          reject(new Error('Iklan timeout'));
        }
      }, AD_TIMEOUT_MS);

      try {
        // Panggil SDK Monetag
        // Tidak ada dokumentasi callback publik -> anggap muncul, lalu lanjutkan setelah delay pendek
        // Pastikan kata kunci ada: show_9256839(
        window.show_9256839 && window.show_9256839();
        setTimeout(async () => {
          if (finished) return;
          try {
            await callback();
            finished = true;
            clearTimeout(timeoutId);
            resolve(true);
          } catch (err) {
            finished = true;
            clearTimeout(timeoutId);
            reject(err);
          }
        }, 1500);
      } catch (err) {
        clearTimeout(timeoutId);
        showToast('Gagal memuat iklan, coba lagi.', 'error', 3000);
        reject(err);
      }
    });
  }

  // ---------- Provider discovery ----------
  function parseTitle(title) { // parseTitle(title)
    const t = (title || '').toLowerCase();
    return {
      wantsAI: /ai/.test(t),
      capability: 'text-to-image',
      normalizedTitle: title || APP_TITLE
    };
  }

  async function discoverProviders(spec) { // async discoverProviders(spec)
    // Urutkan provider paling relevan untuk text-to-image
    const preferred = ['pollinations', 'craiyon', 'hf-sd', 'stable-horde', 'kobold-horde', 'together', 'fireworks', 'deepinfra', 'openrouter'];
    const list = PROVIDER_CHOICES
      .filter(p => !spec || p.capability.includes(spec.capability || 'text-to-image'))
      .sort((a,b) => preferred.indexOf(a.id) - preferred.indexOf(b.id));
    return list;
  }

  async function loadProviderClient(providerId) { // async loadProviderClient(providerId)
    if (providerId === 'pollinations') {
      return {
        id: 'pollinations',
        name: 'Pollinations.ai',
        async run(input, settings = {}, onProgress = () => {}) {
          // Build url
          const ratio = settings.ratio || '1:1';
          const [w, h] = ratioToSize(ratio, settings.width || DEFAULT_WIDTH, settings.height || DEFAULT_HEIGHT);
          const stylePrefix = styleToPromptPrefix(settings.style || 'auto');
          const prompt = `${stylePrefix}${input}`.trim();
          const seed = Math.floor(Math.random() * 9999999);
          // API: https://image.pollinations.ai/prompt/{prompt}?width=...&height=...
          const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=${w}&height=${h}&seed=${seed}&nologo=true&bypass=true`;
          onProgress(5);
          const res = await fetch(url, { cache: 'no-store', mode: 'cors' });
          onProgress(40);
          const blob = await res.blob();
          onProgress(70);
          return { blob, mime: blob.type || 'image/jpeg', provider: 'pollinations' };
        }
      };
    }
    if (providerId === 'craiyon') {
      return {
        id: 'craiyon',
        name: 'Craiyon',
        async run(input, settings = {}, onProgress = () => {}) {
          const stylePrefix = styleToPromptPrefix(settings.style || 'auto');
          const body = { prompt: `${stylePrefix}${input}`.trim() };
          const res = await fetch('https://backend.craiyon.com/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          onProgress(35);
          if (!res.ok) throw new Error(`Craiyon error: ${res.status}`);
          const data = await res.json();
          if (!data.images || !data.images.length) throw new Error('Craiyon tidak mengembalikan gambar');
          // Ambil gambar pertama (base64)
          const b64 = data.images[0];
          const blob = base64ToBlob(b64, 'image/webp');
          onProgress(75);
          return { blob, mime: 'image/webp', provider: 'craiyon' };
        }
      };
    }
    // Stubs untuk provider lain -> lempar agar pipeline fallback ke Pollinations
    return {
      id: providerId,
      name: providerId,
      async run() {
        throw new Error(`Provider ${providerId} memerlukan kredensial atau tidak tersedia langsung`);
      }
    };
  }

  function buildPipeline(capabilityKey) { // buildPipeline(capabilityKey) → run(input, settings, onProgress)
    return {
      async run(input, settings = {}, onProgress = () => {}) {
        const list = await discoverProviders({ capability: capabilityKey });
        const preferredId = (els.provider.value && els.provider.value !== 'auto') ? els.provider.value : null;
        const ordered = preferredId
          ? [list.find(p => p.id === preferredId), ...list.filter(p => p.id !== preferredId)].filter(Boolean)
          : list;
        let lastErr = null;
        for (let i = 0; i < ordered.length; i++) {
          const p = ordered[i];
          try {
            onProgress(10 + i * 5);
            const client = await loadProviderClient(p.id);
            const result = await client.run(input, settings, prog => {
              // Map ke progress bar
              LoadingBar.tick(Math.max(1, Math.floor(prog / 5)));
            });
            return result;
          } catch (err) {
            lastErr = err;
            // lanjut fallback
          }
        }
        throw lastErr || new Error('Semua provider gagal.');
      }
    };
  }

  // ---------- Helpers ----------
  function ratioToSize(ratio, w = DEFAULT_WIDTH, h = DEFAULT_HEIGHT) {
    switch (ratio) {
      case '3:4': return [Math.min(w, 768), Math.min(h*4/3, 1024)];
      case '4:3': return [Math.min(w*4/3, 1024), Math.min(h, 768)];
      case '16:9': return [1024, 576];
      default: return [w, h];
    }
  }
  function styleToPromptPrefix(style) {
    switch (style) {
      case 'photoreal': return 'photorealistic, ultra realistic, 8k, ';
      case 'digital-art': return 'digital art, trending on artstation, ';
      case 'anime': return 'anime style, vibrant, ';
      case 'comic': return 'comic book style, bold lines, ';
      case 'oil-painting': return 'oil painting, textured brush strokes, ';
      default: return '';
    }
  }
  function base64ToBlob(b64, mime = 'application/octet-stream') {
    const byteChars = atob(b64);
    const byteNumbers = new Array(byteChars.length);
    for (let i = 0; i < byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
    const byteArray = new Uint8Array(byteNumbers);
    return new Blob([byteArray], { type: mime });
  }

  // ---------- State ----------
  const state = {
    lastBlob: null,
    lastDataUrl: null,
    lastProvider: null,
  };

  // ---------- Actions ----------
  async function onGenerateClick() { // onGenerateClick(
    await withMonetagInApp(async () => {
      const prompt = (els.prompt.value || '').trim();
      if (!prompt) {
        showToast('Mohon isi deskripsi teks terlebih dahulu.', 'error');
        return;
      }
      lockToolbarButtons();
      LoadingBar.start('Menghasilkan gambar...');
      try {
        const settings = {
          style: els.style.value,
          ratio: els.ratio.value
        };
        const pipeline = buildPipeline('text-to-image');
        LoadingBar.tick(5);
        const result = await pipeline.run(prompt, settings, v => LoadingBar.tick(Math.max(1, Math.floor(v/5))));
        LoadingBar.setLabel('Mengonversi hasil...');
        const dataUrl = await blobToDataURL(result.blob);
        state.lastBlob = result.blob;
        state.lastDataUrl = dataUrl;
        state.lastProvider = result.provider || 'auto';

        // Update UI
        els.placeholder.style.display = 'none';
        els.resultImg.style.display = 'block';
        els.resultImg.src = dataUrl;
        els.resultImg.alt = `Hasil AI (${state.lastProvider})`;

        els.btnShare.removeAttribute('disabled');
        LoadingBar.finish('Gambar siap');
        showToast(`Sukses dari ${state.lastProvider}`, 'success');
      } catch (err) {
        console.error(err);
        LoadingBar.fail('Gagal membuat gambar');
        showToast(`Gagal: ${err.message}`, 'error', 4000);
      } finally {
        unlockToolbarButtons();
      }
    }, 'Buat');
  }

  async function onShareClick() { // onShareClick(
    await withMonetagInApp(async () => {
      if (!state.lastDataUrl) {
        showToast('Belum ada gambar untuk dibagikan.', 'error');
        return;
      }
      LoadingBar.start('Menyiapkan share...');
      LoadingBar.tick(20);
      try {
        // Utamakan API resmi Telegram
        if (Telegram.WebApp && typeof Telegram.WebApp.shareToStory === 'function') {
          // Telegram.WebApp.shareToStory()
          await Telegram.WebApp.shareToStory(state.lastDataUrl, {
            text: 'Dibuat dengan MDM AI Maker',
            widget_link: 'https://t.me',
          });
          LoadingBar.finish('Terkirim ke Story');
          showToast('Dibagikan ke Telegram Story.', 'success');
          return;
        }

        // Fallback: openLink
        if (Telegram.WebApp && typeof Telegram.WebApp.openLink === 'function') {
          // Telegram.WebApp.openLink()
          await Telegram.WebApp.openLink(state.lastDataUrl);
          LoadingBar.finish('Tautan dibuka');
          showToast('Tautan pratinjau dibuka.', 'success');
          return;
        }

        // Sandbox fallback
        LoadingBar.finish('Siap disimpan');
        showToast('Tap & tahan gambar untuk menyimpan ke perangkat. Semua preview ditampilkan dalam Base64 Image.', 'info', 5000);
      } catch (err) {
        console.error(err);
        LoadingBar.fail('Share gagal');
        showToast('Share gagal. Tap & tahan gambar untuk menyimpan ke perangkat. Semua preview ditampilkan dalam Base64 Image.', 'error', 6000);
      }
    }, 'Share');
  }

  function onSupportClick() { // onSupportClick()
    window.location.href = 'mailto:marilmudotmarepeng@gmail.com';
  }

  // ---------- Preflight ----------
  function runPreflightChecks() { // runPreflightChecks()
    const checks = {
      monetagSnippet: true, // kita asumsikan snippet tertanam (diverifikasi via monetagReady pada runtime)
      header: !!document.querySelector('[data-sticky="header"]'),
      footer: !!document.querySelector('[data-sticky="footer"]'),
      progressAPI: typeof LoadingBar.start === 'function'
        && typeof LoadingBar.tick === 'function'
        && typeof LoadingBar.setLabel === 'function'
        && typeof LoadingBar.finish === 'function'
        && typeof LoadingBar.fail === 'function',
      keywords: true // keperluan string presence dicek oleh instruksi eksternal
    };
    const ok = Object.values(checks).every(Boolean);
    if (!ok) console.warn('Preflight checks:', checks);
    return ok;
  }

  // ---------- Init ----------
  async function initApp({ title, options } = {}) { // async initApp({ title, options })
    // Title and brand
    document.title = `${title || APP_TITLE} — MDM`;
    // Theme
    initTheme();

    // Fill providers select
    const fragment = document.createDocumentFragment();
    PROVIDER_CHOICES.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id; opt.textContent = p.name;
      fragment.appendChild(opt);
    });
    els.provider.appendChild(fragment);

    // Events
    els.btnTheme.addEventListener('click', toggleTheme);
    els.btnMenu.addEventListener('click', () => showModal('modalMenu'));
    els.btnCloseModal.addEventListener('click', () => closeModal('modalMenu'));
    els.btnClosePage.addEventListener('click', () => closeModal('modalPage'));
    els.btnGenerate.addEventListener('click', onGenerateClick);
    els.btnShare.addEventListener('click', onShareClick);
    document.querySelectorAll('[data-link]').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const id = a.getAttribute('data-link');
        openStaticPage(id);
      });
    });

    // Telegram readiness
    try {
      Telegram.WebApp && Telegram.WebApp.ready();
      Telegram.WebApp && Telegram.WebApp.expand && Telegram.WebApp.expand();
    } catch {}

    // Preflight
    runPreflightChecks();
  }

  // ---------- Static pages (modal) ----------
  function openStaticPage(id) {
    let title = 'Informasi';
    let html = '';
    if (id === 'profil') {
      title = 'Profil';
      html = `
        <p><strong>MDM (marilmu dot marepeng)</strong> adalah pemilik dan pengelola aplikasi AI Maker Teks To Image.</p>
        <p>Fokus pada pengalaman premium, cepat, dan andal dengan fallback ke 20 penyedia AI.</p>
      `;
    } else if (id === 'privacy') {
      title = 'Privacy Policy';
      html = `
        <p>Kami tidak mengumpulkan data pribadi sensitif. Prompt dapat digunakan untuk peningkatan layanan.</p>
        <p>Gambar dihasilkan oleh penyedia pihak ketiga sesuai kebijakan mereka.</p>
      `;
    } else if (id === 'disclaimer') {
      title = 'Disclaimer';
      html = `
        <p>Hasil AI dapat bervariasi dan tidak dijamin akurasinya. Gunakan secara bertanggung jawab.</p>
        <p>Seluruh merek dagang adalah milik pemiliknya masing-masing.</p>
      `;
    } else {
      title = 'Informasi';
      html = `<p>Halaman tidak ditemukan.</p>`;
    }
    els.modalPageTitle.textContent = title;
    els.modalPageBody.innerHTML = html;
    showModal('modalPage');
  }

  // ---------- Expose required names (no globals pollution) ----------
  window.mdmApp = {
    initApp,
    parseTitle,
    PROVIDER_CHOICES,
    discoverProviders,
    loadProviderClient,
    buildPipeline,
    onGenerateClick,
    onShareClick,
    onSupportClick,
    withMonetagInApp,
    monetagReady,
    unlockToolbarButtons,
    lockToolbarButtons,
    LoadingBar,
    showModal,
    closeModal,
    showToast,
    downloadBlob,
    runPreflightChecks
  };

  // ---------- Boot ----------
  document.addEventListener('DOMContentLoaded', () => {
    const parsed = parseTitle(APP_TITLE);
    initApp({ title: parsed.normalizedTitle, options: parsed });
  });

  // Keep required text for preflight scanners
  // "Tap & tahan gambar untuk menyimpan ke perangkat. Semua preview ditampilkan dalam Base64 Image."
})();
</script>
</body>
</html>
